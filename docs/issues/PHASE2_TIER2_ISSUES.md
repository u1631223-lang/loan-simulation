# Phase 2 (Tier 2): AIæ©Ÿèƒ½çµ±åˆ - Issue List

**ç›®æ¨™**: ã€Œãƒ—ãƒ­æœ‰æ–™ç‰ˆï¼ˆÂ¥4,980/æœˆï¼‰ã€ã¨ã—ã¦ç«¶åˆã¨ã®æ±ºå®šçš„å·®åˆ¥åŒ–
**æœŸé–“**: 6ãƒ¶æœˆ
**å„ªå…ˆåº¦**: Phase 1å®Œäº†å¾Œã«ç€æ‰‹

---

## ğŸ“Š æ¦‚è¦

### é”æˆç›®æ¨™

- âœ… AIãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆï¼ˆå¯¾è©±å‹ãƒ‡ãƒ¼ã‚¿åé›†ï¼‰
- âœ… éŸ³å£°å…¥åŠ›å¯¾å¿œï¼ˆWhisper APIï¼‰
- âœ… AIåˆ†æãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆ
- âœ… å®¶è¨ˆç°¿APIé€£æºï¼ˆå®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼‰
- âœ… é¡§å®¢ãƒãƒ¼ã‚¿ãƒ«ï¼ˆPWAï¼‰
- âœ… ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆAIäºˆæ¸¬

### KPI

| æŒ‡æ¨™ | ç›®æ¨™å€¤ |
|------|--------|
| ç„¡æ–™ç‰ˆç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ | 2,000å |
| ãƒ©ã‚¤ãƒˆç‰ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ | 300å |
| ãƒ—ãƒ­ç‰ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ | 200å |
| æœˆæ¬¡åç›Šï¼ˆMRRï¼‰ | Â¥1,390,000 |
| NPS | 50ä»¥ä¸Š |

### å…¨ä½“å·¥æ•°

| åˆè¨ˆæœŸé–“ | ç´„6ãƒ¶æœˆï¼ˆ24é€±é–“ï¼‰ |
|---------|-----------------|
| ç·Issueæ•° | 6ä»¶ |

---

## ğŸ« Issueä¸€è¦§

| Issue | ã‚¿ã‚¤ãƒˆãƒ« | å„ªå…ˆåº¦ | æœŸé–“ | ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ | ä¾å­˜ |
|-------|---------|--------|------|----------------|------|
| ISSUE-201 | AIãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ | ğŸ”´ Critical | 5é€±é–“ | âŒ | Phase 1å®Œäº† |
| ISSUE-202 | éŸ³å£°å…¥åŠ›ï¼ˆWhisper APIï¼‰ | ğŸŸ¡ High | 3é€±é–“ | âœ… | 201 |
| ISSUE-203 | AIåˆ†æãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ | ğŸ”´ Critical | 4é€±é–“ | âŒ | 201 |
| ISSUE-204 | å®¶è¨ˆç°¿APIé€£æº | ğŸŸ¡ High | 4é€±é–“ | âœ… | Phase 1å®Œäº† |
| ISSUE-205 | é¡§å®¢ãƒãƒ¼ã‚¿ãƒ«ï¼ˆPWAï¼‰ | ğŸŸ¡ High | 5é€±é–“ | âŒ | Phase 1å®Œäº† |
| ISSUE-206 | ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆAIäºˆæ¸¬ | ğŸŸ¢ Medium | 3é€±é–“ | âœ… | 201 |

### ä¸¦åˆ—å®Ÿè¡Œæˆ¦ç•¥

```
Week 1-5:   ISSUE-201 (AI Hearing) || ISSUE-204 (å®¶è¨ˆç°¿API) || ISSUE-205 (é¡§å®¢ãƒãƒ¼ã‚¿ãƒ«)
Week 6-8:   ISSUE-202 (éŸ³å£°å…¥åŠ›)
Week 9-12:  ISSUE-203 (AIåˆ†æãƒ¬ãƒãƒ¼ãƒˆ) || ISSUE-206 (AIäºˆæ¸¬)
Week 13-24: çµ±åˆãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¯¾å¿œ
```

---

## ISSUE-201: AIãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ ğŸ”´ Critical

### ğŸ“‹ æ¦‚è¦

ãƒãƒ£ãƒƒãƒˆå½¢å¼ã§FPãŒé¡§å®¢æƒ…å ±ã‚’åŠ¹ç‡çš„ã«åé›†ã§ãã‚‹AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚Google Gemini 1.5 Flashã‚’ä½¿ç”¨ã—ã€è‡ªç„¶ãªå¯¾è©±ã§å¹´é½¢ãƒ»å®¶æ—æ§‹æˆãƒ»å¹´åãƒ»ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ã®å¸Œæœ›ã‚’èãå‡ºã—ã¾ã™ã€‚

**èƒŒæ™¯**:
- æ—¢å­˜FPãƒ„ãƒ¼ãƒ«ã§ã¯ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚·ãƒ¼ãƒˆã‚’æ‰‹å…¥åŠ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€æ™‚é–“ãŒã‹ã‹ã‚‹
- é¡§å®¢ã‚‚ç¡¬ã„è³ªå•å½¢å¼ã ã¨å¿ƒç†çš„ãƒãƒ¼ãƒ‰ãƒ«ãŒé«˜ã„
- AIã¨ã®å¯¾è©±å½¢å¼ã«ã™ã‚‹ã“ã¨ã§ã€æ°—è»½ã«ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã§ãã‚‹

### ğŸ¯ ã‚¿ã‚¹ã‚¯è©³ç´°

#### 1. Google Gemini APIçµ±åˆ

```bash
npm install @google/generative-ai
```

```typescript
// src/lib/gemini.ts
import { GoogleGenerativeAI } from '@google/generative-ai';

const apiKey = import.meta.env.VITE_GEMINI_API_KEY || '';
export const genAI = new GoogleGenerativeAI(apiKey);

// Gemini 1.5 Flash: é«˜é€Ÿãƒ»ä½ã‚³ã‚¹ãƒˆï¼ˆãƒ’ã‚¢ãƒªãƒ³ã‚°ç”¨ï¼‰
export const flashModel = genAI.getGenerativeModel({
  model: 'gemini-1.5-flash',
  generationConfig: {
    temperature: 0.7,
    topP: 0.8,
    topK: 40,
    maxOutputTokens: 1024,
    responseMimeType: 'application/json',
  },
});

// Gemini 1.5 Pro: é«˜ç²¾åº¦ï¼ˆåˆ†æãƒ¬ãƒãƒ¼ãƒˆç”¨ï¼‰
export const proModel = genAI.getGenerativeModel({
  model: 'gemini-1.5-pro',
  generationConfig: {
    temperature: 0.5,
    topP: 0.9,
    topK: 40,
    maxOutputTokens: 2048,
  },
});
```

#### 2. ãƒ’ã‚¢ãƒªãƒ³ã‚°å‹å®šç¾©

```typescript
// src/types/hearing.ts
export interface HearingMessage {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: Date;
}

export interface HearingData {
  // åŸºæœ¬æƒ…å ±
  age?: number;
  occupation?: string;
  annualIncome?: number;
  currentSavings?: number;

  // å®¶æ—æ§‹æˆ
  married?: boolean;
  spouseAge?: number;
  spouseIncome?: number;
  children?: Array<{
    name: string;
    birthYear: number;
  }>;

  // ä½å®…
  housingStatus?: 'owned' | 'rented' | 'planning';
  loanAmount?: number;
  loanYears?: number;
  loanInterestRate?: number;

  // ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³å¸Œæœ›
  retirementAge?: number;
  goals?: string[];
  concerns?: string[];
}

export interface HearingResponse {
  nextQuestion: {
    question: string;
    suggestedAnswers?: string[];
    category: 'basic' | 'family' | 'finance' | 'housing' | 'goals';
  };
  extractedData: Partial<HearingData>;
  progress: number; // 0-100%
  isComplete: boolean;
}
```

#### 3. AIãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹

```typescript
// src/services/ai/hearingService.ts
import { flashModel } from '@/lib/gemini';
import { HearingMessage, HearingData, HearingResponse } from '@/types/hearing';

const SYSTEM_PROMPT = `ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚·ãƒ£ãƒ«ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã®ãƒ’ã‚¢ãƒªãƒ³ã‚°ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

ã€ã‚ãªãŸã®å½¹å‰²ã€‘
é¡§å®¢ã‹ã‚‰ä»¥ä¸‹ã®æƒ…å ±ã‚’è‡ªç„¶ãªä¼šè©±å½¢å¼ã§èãå‡ºã—ã¦ãã ã•ã„ï¼š
1. åŸºæœ¬æƒ…å ±ï¼ˆå¹´é½¢ãƒ»è·æ¥­ãƒ»å¹´åãƒ»è²¯è“„é¡ï¼‰
2. å®¶æ—æ§‹æˆï¼ˆé…å¶è€…ãƒ»å­ä¾›ã®æœ‰ç„¡ã¨å¹´é½¢ï¼‰
3. ä½å®…çŠ¶æ³ï¼ˆæŒã¡å®¶ãƒ»è³ƒè²¸ãƒ»ä½å®…è³¼å…¥äºˆå®šï¼‰
4. ä½å®…ãƒ­ãƒ¼ãƒ³ï¼ˆå€Ÿå…¥é¡ãƒ»è¿”æ¸ˆæœŸé–“ãƒ»é‡‘åˆ©ï¼‰
5. ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ã®å¸Œæœ›ï¼ˆæ•™è‚²ãƒ»è€å¾Œãƒ»ãã®ä»–ã®ç›®æ¨™ï¼‰
6. ä¸å®‰ãƒ»æ‡¸å¿µäº‹é …

ã€å¯¾å¿œãƒ«ãƒ¼ãƒ«ã€‘
1. ä¸€åº¦ã«1ã€œ2å€‹ã®è³ªå•ã«çµã‚‹ï¼ˆæƒ…å ±éå¤šã‚’é¿ã‘ã‚‹ï¼‰
2. å›ç­”ã«å¿œã˜ã¦å…±æ„Ÿãƒ»åŠ±ã¾ã—ã®è¨€è‘‰ã‚’æ·»ãˆã‚‹
3. å°‚é–€ç”¨èªã¯é¿ã‘ã€ã‚ã‹ã‚Šã‚„ã™ã„è¨€è‘‰ã‚’ä½¿ã†
4. æ•°å€¤ã¯å…·ä½“çš„ã«èãï¼ˆã€Œ300ä¸‡å††ãã‚‰ã„ã§ã™ã‹ï¼Ÿã€ç­‰ï¼‰
5. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã«é…æ…®ã—ã€ç­”ãˆãŸããªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—å¯èƒ½ã¨ä¼ãˆã‚‹

ã€å‡ºåŠ›å½¢å¼ã€‘
JSONå½¢å¼ã§ä»¥ä¸‹ã‚’è¿”ã—ã¦ãã ã•ã„ï¼š
{
  "nextQuestion": {
    "question": "æ¬¡ã®è³ªå•å†…å®¹",
    "suggestedAnswers": ["é¸æŠè‚¢1", "é¸æŠè‚¢2", ...],
    "category": "basic" | "family" | "finance" | "housing" | "goals"
  },
  "extractedData": {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã‹ã‚‰æŠ½å‡ºã—ãŸãƒ‡ãƒ¼ã‚¿
  },
  "progress": 0ã€œ100,
  "isComplete": false | true
}`;

export async function processHearingMessage(
  conversationHistory: HearingMessage[],
  userMessage: string,
  currentData: Partial<HearingData>
): Promise<HearingResponse> {
  const history = conversationHistory.map((msg) => ({
    role: msg.role === 'user' ? 'user' : 'model',
    parts: [{ text: msg.content }],
  }));

  const chat = flashModel.startChat({
    history,
    systemInstruction: SYSTEM_PROMPT,
  });

  const prompt = `ã€ç¾åœ¨ã®åé›†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã€‘
${JSON.stringify(currentData, null, 2)}

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€æ–°ç™ºè¨€ã€‘
${userMessage}

ä¸Šè¨˜ã‚’è¸ã¾ãˆã€æ¬¡ã®è³ªå•ã¨æŠ½å‡ºãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚`;

  const result = await chat.sendMessage(prompt);
  const responseText = result.response.text();

  // JSONæŠ½å‡ºï¼ˆMarkdown codeblockãŒã‚ã‚‹å ´åˆã«å¯¾å¿œï¼‰
  const jsonMatch = responseText.match(/```json\n([\s\S]*?)\n```/) || responseText.match(/{[\s\S]*}/);
  const jsonText = jsonMatch ? (jsonMatch[1] || jsonMatch[0]) : responseText;

  return JSON.parse(jsonText) as HearingResponse;
}
```

#### 4. ãƒ’ã‚¢ãƒªãƒ³ã‚°ãƒãƒ£ãƒƒãƒˆUI

```typescript
// src/components/Hearing/HearingChat.tsx
import { useState, useRef, useEffect } from 'react';
import { HearingMessage, HearingData } from '@/types/hearing';
import { processHearingMessage } from '@/services/ai/hearingService';
import { supabase } from '@/lib/supabase';
import { useAuth } from '@/contexts/AuthContext';
import { useToast } from '@/hooks/useToast';

export function HearingChat() {
  const { user } = useAuth();
  const { showToast } = useToast();
  const [messages, setMessages] = useState<HearingMessage[]>([
    {
      id: '1',
      role: 'assistant',
      content: 'ã“ã‚“ã«ã¡ã¯ï¼ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ã®ãŠæ‰‹ä¼ã„ã‚’ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚ã¾ãšã¯ã€ãŠåå‰ã¨ç¾åœ¨ã®å¹´é½¢ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ',
      timestamp: new Date(),
    },
  ]);
  const [inputValue, setInputValue] = useState('');
  const [loading, setLoading] = useState(false);
  const [hearingData, setHearingData] = useState<Partial<HearingData>>({});
  const [progress, setProgress] = useState(0);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const handleSend = async () => {
    if (!inputValue.trim() || loading) return;

    const userMessage: HearingMessage = {
      id: Date.now().toString(),
      role: 'user',
      content: inputValue,
      timestamp: new Date(),
    };

    setMessages((prev) => [...prev, userMessage]);
    setInputValue('');
    setLoading(true);

    try {
      const response = await processHearingMessage(messages, inputValue, hearingData);

      // æŠ½å‡ºãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
      setHearingData((prev) => ({ ...prev, ...response.extractedData }));
      setProgress(response.progress);

      // AIã®è¿”ç­”ã‚’è¿½åŠ 
      const assistantMessage: HearingMessage = {
        id: (Date.now() + 1).toString(),
        role: 'assistant',
        content: response.nextQuestion.question,
        timestamp: new Date(),
      };
      setMessages((prev) => [...prev, assistantMessage]);

      // ãƒ’ã‚¢ãƒªãƒ³ã‚°å®Œäº†æ™‚
      if (response.isComplete) {
        showToast('ãƒ’ã‚¢ãƒªãƒ³ã‚°ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
        await saveHearingData();
      }
    } catch (error) {
      console.error('Error processing message:', error);
      showToast('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    } finally {
      setLoading(false);
    }
  };

  const saveHearingData = async () => {
    if (!user) return;

    try {
      // life_plans ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
      const { data, error } = await supabase
        .from('life_plans')
        .insert({
          user_id: user.id,
          name: `${hearingData.age}æ­³ã®ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³`,
          current_age: hearingData.age || 30,
          retirement_age: hearingData.retirementAge || 65,
          life_expectancy: 100,
          data: hearingData,
        })
        .select()
        .single();

      if (error) throw error;

      showToast('ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
      // TODO: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    } catch (error) {
      console.error('Error saving hearing data:', error);
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
  };

  return (
    <div className="flex flex-col h-screen max-h-screen">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="bg-blue-600 text-white p-4">
        <h1 className="text-xl font-bold">AIãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ãƒ’ã‚¢ãƒªãƒ³ã‚°</h1>
        <div className="mt-2">
          <div className="w-full bg-blue-400 rounded-full h-2">
            <div
              className="bg-white rounded-full h-2 transition-all duration-500"
              style={{ width: `${progress}%` }}
            />
          </div>
          <p className="text-xs mt-1">é€²æ—: {progress}%</p>
        </div>
      </div>

      {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
        {messages.map((message) => (
          <div
            key={message.id}
            className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}
          >
            <div
              className={`max-w-[70%] p-3 rounded-lg ${
                message.role === 'user'
                  ? 'bg-blue-500 text-white'
                  : 'bg-white border border-gray-200'
              }`}
            >
              <p className="whitespace-pre-wrap">{message.content}</p>
              <p className="text-xs opacity-70 mt-1">
                {message.timestamp.toLocaleTimeString('ja-JP', {
                  hour: '2-digit',
                  minute: '2-digit',
                })}
              </p>
            </div>
          </div>
        ))}
        {loading && (
          <div className="flex justify-start">
            <div className="bg-white border border-gray-200 p-3 rounded-lg">
              <div className="flex space-x-2">
                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" />
                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }} />
                <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }} />
              </div>
            </div>
          </div>
        )}
        <div ref={messagesEndRef} />
      </div>

      {/* å…¥åŠ›ã‚¨ãƒªã‚¢ */}
      <div className="border-t p-4 bg-white">
        <div className="flex gap-2">
          <input
            type="text"
            value={inputValue}
            onChange={(e) => setInputValue(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && handleSend()}
            placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
            className="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            disabled={loading}
          />
          <button
            onClick={handleSend}
            disabled={loading || !inputValue.trim()}
            className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            é€ä¿¡
          </button>
        </div>
      </div>
    </div>
  );
}
```

### âœ… å®Œäº†æ¡ä»¶

- [ ] Gemini APIçµ±åˆ
- [ ] ãƒ’ã‚¢ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
- [ ] ãƒãƒ£ãƒƒãƒˆUIå®Ÿè£…
- [ ] ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºç²¾åº¦90%ä»¥ä¸Š
- [ ] é€²æ—è¡¨ç¤ºæ©Ÿèƒ½
- [ ] life_plansãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®ä¿å­˜
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ 3ç§’ä»¥å†…
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- [ ] ãƒ†ã‚¹ãƒˆä½œæˆï¼ˆE2Eãƒ†ã‚¹ãƒˆå«ã‚€ï¼‰

### ğŸ”§ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- Google Gemini 1.5 Flash API
- React
- Supabase

### ğŸ“ æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«

```
src/
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ gemini.ts
â”œâ”€â”€ services/
â”‚   â””â”€â”€ ai/
â”‚       â””â”€â”€ hearingService.ts
â”œâ”€â”€ components/
â”‚   â””â”€â”€ Hearing/
â”‚       â”œâ”€â”€ HearingChat.tsx
â”‚       â””â”€â”€ HearingProgress.tsx
â””â”€â”€ types/
    â””â”€â”€ hearing.ts
```

### ğŸš« ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå§”ä»»: ä¸å¯

**ç†ç”±**: AIçµ±åˆã®ä¸­æ ¸æ©Ÿèƒ½ã§ã‚ã‚Šã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã®èª¿æ•´ãŒå¿…è¦

---

## ISSUE-202: éŸ³å£°å…¥åŠ›ï¼ˆWhisper APIï¼‰ ğŸŸ¡ High

### ğŸ“‹ æ¦‚è¦

FPã¨é¡§å®¢ã®å¯¾è©±ã‚’éŸ³å£°ã§éŒ²éŸ³ã—ã€è‡ªå‹•çš„ã«ãƒ†ã‚­ã‚¹ãƒˆåŒ–ã—ã¦ãƒ’ã‚¢ãƒªãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã«åæ˜ ã—ã¾ã™ã€‚

### ğŸ¯ ã‚¿ã‚¹ã‚¯è©³ç´°

#### 1. OpenAI Whisper APIçµ±åˆ

```bash
npm install openai
```

```typescript
// src/services/ai/whisperService.ts
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: import.meta.env.VITE_OPENAI_API_KEY || '',
  dangerouslyAllowBrowser: true, // æœ¬ç•ªç’°å¢ƒã§ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµŒç”±æ¨å¥¨
});

export async function transcribeAudio(audioFile: File): Promise<string> {
  try {
    const transcription = await openai.audio.transcriptions.create({
      file: audioFile,
      model: 'whisper-1',
      language: 'ja',
      response_format: 'text',
    });

    return transcription;
  } catch (error) {
    console.error('Error transcribing audio:', error);
    throw error;
  }
}
```

#### 2. éŸ³å£°éŒ²éŸ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```typescript
// src/components/Hearing/VoiceRecorder.tsx
import { useState, useRef } from 'react';
import { transcribeAudio } from '@/services/ai/whisperService';
import { useToast } from '@/hooks/useToast';

interface VoiceRecorderProps {
  onTranscriptComplete: (transcript: string) => void;
}

export function VoiceRecorder({ onTranscriptComplete }: VoiceRecorderProps) {
  const { showToast } = useToast();
  const [recording, setRecording] = useState(false);
  const [transcribing, setTranscribing] = useState(false);
  const mediaRecorderRef = useRef<MediaRecorder | null>(null);
  const chunksRef = useRef<Blob[]>([]);

  const startRecording = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream);
      mediaRecorderRef.current = mediaRecorder;
      chunksRef.current = [];

      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          chunksRef.current.push(event.data);
        }
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(chunksRef.current, { type: 'audio/webm' });
        const audioFile = new File([audioBlob], 'recording.webm', { type: 'audio/webm' });

        setTranscribing(true);
        try {
          const transcript = await transcribeAudio(audioFile);
          onTranscriptComplete(transcript);
          showToast('éŸ³å£°ã‚’ãƒ†ã‚­ã‚¹ãƒˆåŒ–ã—ã¾ã—ãŸ', 'success');
        } catch (error) {
          showToast('éŸ³å£°èªè­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        } finally {
          setTranscribing(false);
        }

        // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
        stream.getTracks().forEach((track) => track.stop());
      };

      mediaRecorder.start();
      setRecording(true);
      showToast('éŒ²éŸ³ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'info');
    } catch (error) {
      console.error('Error starting recording:', error);
      showToast('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
    }
  };

  const stopRecording = () => {
    if (mediaRecorderRef.current && recording) {
      mediaRecorderRef.current.stop();
      setRecording(false);
    }
  };

  return (
    <div className="flex flex-col items-center gap-4">
      <button
        onClick={recording ? stopRecording : startRecording}
        disabled={transcribing}
        className={`w-16 h-16 rounded-full ${
          recording
            ? 'bg-red-500 hover:bg-red-600 animate-pulse'
            : 'bg-blue-500 hover:bg-blue-600'
        } text-white flex items-center justify-center disabled:opacity-50`}
      >
        {transcribing ? (
          <span className="text-xs">å‡¦ç†ä¸­</span>
        ) : recording ? (
          <span className="text-2xl">â¹</span>
        ) : (
          <span className="text-2xl">ğŸ¤</span>
        )}
      </button>
      <p className="text-sm text-gray-600">
        {transcribing ? 'ãƒ†ã‚­ã‚¹ãƒˆåŒ–ä¸­...' : recording ? 'éŒ²éŸ³ä¸­...' : 'éŒ²éŸ³é–‹å§‹'}
      </p>
    </div>
  );
}
```

### âœ… å®Œäº†æ¡ä»¶

- [ ] Whisper APIçµ±åˆ
- [ ] ãƒ–ãƒ©ã‚¦ã‚¶éŸ³å£°éŒ²éŸ³å®Ÿè£…
- [ ] VoiceRecorderã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…
- [ ] HearingChatã¸ã®çµ±åˆ
- [ ] æ—¥æœ¬èªèªè­˜ç²¾åº¦95%ä»¥ä¸Š
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- [ ] ãƒã‚¤ã‚¯æ¨©é™å‡¦ç†
- [ ] ãƒ†ã‚¹ãƒˆä½œæˆ

### ğŸ”§ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- OpenAI Whisper API
- Web Audio API
- MediaRecorder API

### ğŸ“ æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«

```
src/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ ai/
â”‚       â””â”€â”€ whisperService.ts
â””â”€â”€ components/
    â””â”€â”€ Hearing/
        â””â”€â”€ VoiceRecorder.tsx
```

### âœ… ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå§”ä»»: å¯èƒ½

---

## ISSUE-203: AIåˆ†æãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆ ğŸ”´ Critical

### ğŸ“‹ æ¦‚è¦

ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼åˆ†æã‚’AIãŒè‡ªå‹•ã§æ–‡ç« åŒ–ã—ã€èª²é¡Œãƒ»æ”¹å–„ææ¡ˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚Gemini 1.5 Proã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

### ğŸ¯ ã‚¿ã‚¹ã‚¯è©³ç´°

```typescript
// src/services/ai/analysisService.ts
import { proModel } from '@/lib/gemini';
import { MonthlyCashFlow } from '@/utils/cashFlowCalculator';
import { HearingData } from '@/types/hearing';

export interface AnalysisReport {
  summary: string;
  challenges: string[];
  recommendations: string[];
  riskLevel: 'low' | 'medium' | 'high';
}

export async function generateAnalysisReport(
  cashFlow: MonthlyCashFlow[],
  hearingData: HearingData
): Promise<AnalysisReport> {
  const shortages = cashFlow.filter((cf) => cf.savings < 0);
  const peak = cashFlow.reduce((max, cf) => (cf.savings > max.savings ? cf : max), cashFlow[0]);
  const bottom = cashFlow.reduce((min, cf) => (cf.savings < min.savings ? cf : min), cashFlow[0]);

  const prompt = `ä»¥ä¸‹ã®ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’åˆ†æã—ã€ç·åˆè©•ä¾¡ãƒ»èª²é¡Œãƒ»æ”¹å–„ææ¡ˆã‚’æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ã€é¡§å®¢æƒ…å ±ã€‘
- å¹´é½¢: ${hearingData.age}æ­³
- å¹´å: ${hearingData.annualIncome?.toLocaleString()}å††
- è²¯è“„: ${hearingData.currentSavings?.toLocaleString()}å††
- å®¶æ—æ§‹æˆ: ${hearingData.married ? 'æ—¢å©š' : 'ç‹¬èº«'}ã€å­ä¾›${hearingData.children?.length || 0}äºº
- ä½å®…ãƒ­ãƒ¼ãƒ³: ${hearingData.loanAmount ? `${(hearingData.loanAmount / 10000).toLocaleString()}ä¸‡å††` : 'ãªã—'}

ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼åˆ†æã€‘
- è²¯è“„ãƒ”ãƒ¼ã‚¯: ${(peak.savings / 10000).toLocaleString()}ä¸‡å†† (${peak.year}å¹´ã€${peak.age}æ­³)
- è²¯è“„æœ€ä½: ${(bottom.savings / 10000).toLocaleString()}ä¸‡å†† (${bottom.year}å¹´ã€${bottom.age}æ­³)
- è³‡é‡‘ã‚·ãƒ§ãƒ¼ãƒˆ: ${shortages.length}ãƒ¶æœˆ${shortages.length > 0 ? `ï¼ˆ${shortages[0].year}å¹´ã‹ã‚‰ç™ºç”Ÿï¼‰` : ''}

ã€å‡ºåŠ›å½¢å¼ã€‘
JSONå½¢å¼ã§ä»¥ä¸‹ã‚’è¿”ã—ã¦ãã ã•ã„ï¼š
{
  "summary": "300æ–‡å­—ç¨‹åº¦ã®ç·åˆè©•ä¾¡",
  "challenges": ["èª²é¡Œ1", "èª²é¡Œ2", "èª²é¡Œ3"],
  "recommendations": ["ææ¡ˆ1", "ææ¡ˆ2", "ææ¡ˆ3"],
  "riskLevel": "low" | "medium" | "high"
}`;

  const result = await proModel.generateContent(prompt);
  const responseText = result.response.text();

  // JSONæŠ½å‡º
  const jsonMatch = responseText.match(/```json\n([\s\S]*?)\n```/) || responseText.match(/{[\s\S]*}/);
  const jsonText = jsonMatch ? (jsonMatch[1] || jsonMatch[0]) : responseText;

  return JSON.parse(jsonText) as AnalysisReport;
}
```

### âœ… å®Œäº†æ¡ä»¶

- [ ] Gemini 1.5 Proçµ±åˆ
- [ ] åˆ†æãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
- [ ] ãƒ¬ãƒãƒ¼ãƒˆç”ŸæˆUI
- [ ] PDFå‡ºåŠ›ã¸ã®çµ±åˆ
- [ ] åˆ†æç²¾åº¦æ¤œè¨¼ï¼ˆå°‚é–€å®¶ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
- [ ] ãƒ†ã‚¹ãƒˆä½œæˆ

### ğŸš« ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå§”ä»»: ä¸å¯

---

## ISSUE-204: å®¶è¨ˆç°¿APIé€£æº ğŸŸ¡ High

### ğŸ“‹ æ¦‚è¦

MoneyForward MEã€Moneytreeã¨é€£æºã—ã€å®Ÿéš›ã®æœˆæ¬¡æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•å–å¾—ã—ã¾ã™ã€‚

*(å®Ÿè£…è©³ç´°ã¯çœç•¥)*

### âœ… å®Œäº†æ¡ä»¶

- [ ] MoneyForward ME APIé€£æº
- [ ] Moneytree APIé€£æº
- [ ] OAuthèªè¨¼å®Ÿè£…
- [ ] ãƒ‡ãƒ¼ã‚¿åŒæœŸæ©Ÿèƒ½
- [ ] ã‚«ãƒ†ã‚´ãƒªè‡ªå‹•åˆ†é¡

### âœ… ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå§”ä»»: å¯èƒ½

---

## ISSUE-205: é¡§å®¢ãƒãƒ¼ã‚¿ãƒ«ï¼ˆPWAï¼‰ ğŸŸ¡ High

### ğŸ“‹ æ¦‚è¦

é¡§å®¢ãŒè‡ªåˆ†ã®ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ã‚’ã‚¹ãƒãƒ›ã§é–²è¦§ãƒ»ç·¨é›†ã§ãã‚‹PWAã‚’å®Ÿè£…ã—ã¾ã™ã€‚

*(å®Ÿè£…è©³ç´°ã¯çœç•¥)*

### âœ… å®Œäº†æ¡ä»¶

- [ ] PWAè¨­å®šï¼ˆmanifest.jsonã€Service Workerï¼‰
- [ ] ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ
- [ ] ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥
- [ ] é¡§å®¢å‘ã‘UIãƒ‡ã‚¶ã‚¤ãƒ³
- [ ] FPã¨ã®ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½

### ğŸš« ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå§”ä»»: ä¸å¯

---

## ISSUE-206: ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆAIäºˆæ¸¬ ğŸŸ¢ Medium

### ğŸ“‹ æ¦‚è¦

å¹´é½¢ãƒ»å¹´åãƒ»å®¶æ—æ§‹æˆã‹ã‚‰çµ±è¨ˆçš„ã«çµå©šãƒ»å‡ºç”£æ™‚æœŸã‚’æ¨å®šã—ã¾ã™ã€‚

*(å®Ÿè£…è©³ç´°ã¯çœç•¥)*

### âœ… å®Œäº†æ¡ä»¶

- [ ] åšåŠ´çœçµ±è¨ˆãƒ‡ãƒ¼ã‚¿çµ±åˆ
- [ ] AIäºˆæ¸¬ãƒ­ã‚¸ãƒƒã‚¯
- [ ] äºˆæ¸¬çµæœè¡¨ç¤ºUI
- [ ] ãƒ©ã‚¤ãƒ•ã‚¤ãƒ™ãƒ³ãƒˆè‡ªå‹•è¿½åŠ æ©Ÿèƒ½

### âœ… ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå§”ä»»: å¯èƒ½

---

## ğŸ“ Phase 2å®Œäº†å¾Œã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] å…¨6 Issueã‚¯ãƒ­ãƒ¼ã‚º
- [ ] AIæ©Ÿèƒ½çµ±åˆãƒ†ã‚¹ãƒˆ
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œãƒ†ã‚¹ãƒˆï¼ˆUATï¼‰
- [ ] æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] ãƒ—ãƒ­ç‰ˆï¼ˆÂ¥4,980/æœˆï¼‰ãƒªãƒªãƒ¼ã‚¹
- [ ] MRR Â¥1,390,000é”æˆ
- [ ] NPS 50ä»¥ä¸Š

---

**Next Phase**: [PHASE3_TIER3_ISSUES.md](./PHASE3_TIER3_ISSUES.md)
