# Phase 3 (Tier 3): ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºæ©Ÿèƒ½ - Issue List

**ç›®æ¨™**: é‡‘èæ©Ÿé–¢ãƒ»å¤§æ‰‹ä¸å‹•ç”£ä¼šç¤¾ã¸ã®å°å…¥ï¼ˆæœˆé¡Â¥50,000ã€œï¼‰
**æœŸé–“**: 12ãƒ¶æœˆ
**å„ªå…ˆåº¦**: Phase 2å®Œäº†å¾Œã«ç€æ‰‹

---

## ğŸ“Š æ¦‚è¦

### é”æˆç›®æ¨™

- âœ… CRMçµ±åˆï¼ˆSalesforce/HubSpot/kintoneï¼‰
- âœ… ãƒãƒ¼ãƒ æ©Ÿèƒ½ï¼ˆRBACãƒ»æ‰¿èªãƒ•ãƒ­ãƒ¼ï¼‰
- âœ… ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹æ©Ÿèƒ½ï¼ˆç›£æŸ»ãƒ­ã‚°ãƒ»é‡‘èåºå¯¾å¿œï¼‰
- âœ… é‡‘èå•†å“DBï¼ˆä¿é™ºãƒ»æŠ•è³‡ä¿¡è¨—ãƒ»iDeCoï¼‰
- âœ… ãƒ›ãƒ¯ã‚¤ãƒˆãƒ©ãƒ™ãƒ«å¯¾å¿œ

### KPI

| æŒ‡æ¨™ | ç›®æ¨™å€¤ |
|------|--------|
| ç„¡æ–™ç‰ˆç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ | 5,000å |
| ãƒ©ã‚¤ãƒˆç‰ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ | 800å |
| ãƒ—ãƒ­ç‰ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ | 700å |
| ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºé¡§å®¢ | 10ç¤¾ |
| æœˆæ¬¡åç›Šï¼ˆMRRï¼‰ | Â¥4,770,000 |
| NPS | 60ä»¥ä¸Š |

### å…¨ä½“å·¥æ•°

| åˆè¨ˆæœŸé–“ | ç´„12ãƒ¶æœˆï¼ˆ48é€±é–“ï¼‰ |
|---------|-----------------|
| ç·Issueæ•° | 5ä»¶ |

---

## ğŸ« Issueä¸€è¦§

| Issue | ã‚¿ã‚¤ãƒˆãƒ« | å„ªå…ˆåº¦ | æœŸé–“ | ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ | ä¾å­˜ |
|-------|---------|--------|------|----------------|------|
| ISSUE-301 | CRMçµ±åˆ | ğŸ”´ Critical | 8é€±é–“ | âŒ | Phase 2å®Œäº† |
| ISSUE-302 | ãƒãƒ¼ãƒ æ©Ÿèƒ½ | ğŸŸ¡ High | 6é€±é–“ | âœ… | Phase 2å®Œäº† |
| ISSUE-303 | ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ | ğŸ”´ Critical | 6é€±é–“ | âŒ | Phase 2å®Œäº† |
| ISSUE-304 | é‡‘èå•†å“DB | ğŸŸ¡ High | 10é€±é–“ | âœ… | Phase 2å®Œäº† |
| ISSUE-305 | ãƒ›ãƒ¯ã‚¤ãƒˆãƒ©ãƒ™ãƒ« | ğŸŸ¢ Medium | 4é€±é–“ | âœ… | Phase 2å®Œäº† |

### ä¸¦åˆ—å®Ÿè¡Œæˆ¦ç•¥

```
Week 1-8:   ISSUE-301 (CRMçµ±åˆ)
Week 9-14:  ISSUE-302 (ãƒãƒ¼ãƒ æ©Ÿèƒ½) || ISSUE-303 (ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹)
Week 15-24: ISSUE-304 (é‡‘èå•†å“DB)
Week 25-28: ISSUE-305 (ãƒ›ãƒ¯ã‚¤ãƒˆãƒ©ãƒ™ãƒ«)
Week 29-48: ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºå–¶æ¥­ãƒ»ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯¾å¿œ
```

---

## ISSUE-301: CRMçµ±åˆ ğŸ”´ Critical

### ğŸ“‹ æ¦‚è¦

Salesforceã€HubSpotã€kintoneã¨é€£æºã—ã€é¡§å®¢æƒ…å ±ã®åŒæ–¹å‘åŒæœŸãƒ»ææ¡ˆå±¥æ­´ã®è‡ªå‹•è¨˜éŒ²ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

**èƒŒæ™¯**:
- é‡‘èæ©Ÿé–¢ã‚„å¤§æ‰‹ä¼æ¥­ã¯ã™ã§ã«CRMã‚’åˆ©ç”¨ã—ã¦ãŠã‚Šã€ãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•ã§ç§»è¡Œã™ã‚‹ã®ã¯éåŠ¹ç‡
- å–¶æ¥­æ´»å‹•å…¨ä½“ã‚’CRMã§ç®¡ç†ã—ãŸã„ãƒ‹ãƒ¼ã‚ºãŒã‚ã‚‹
- FPãƒ„ãƒ¼ãƒ«ã¨CRMã®ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªé€£æºãŒæ±‚ã‚ã‚‰ã‚Œã‚‹

### ğŸ¯ ã‚¿ã‚¹ã‚¯è©³ç´°

#### 1. Salesforce APIçµ±åˆ

```bash
npm install jsforce
```

```typescript
// src/services/crm/salesforceService.ts
import jsforce from 'jsforce';

const SF_LOGIN_URL = import.meta.env.VITE_SALESFORCE_LOGIN_URL || 'https://login.salesforce.com';
const SF_USERNAME = import.meta.env.VITE_SALESFORCE_USERNAME || '';
const SF_PASSWORD = import.meta.env.VITE_SALESFORCE_PASSWORD || '';
const SF_SECURITY_TOKEN = import.meta.env.VITE_SALESFORCE_SECURITY_TOKEN || '';

let conn: jsforce.Connection | null = null;

export async function connectSalesforce(): Promise<jsforce.Connection> {
  if (conn) return conn;

  conn = new jsforce.Connection({
    loginUrl: SF_LOGIN_URL,
  });

  await conn.login(SF_USERNAME, SF_PASSWORD + SF_SECURITY_TOKEN);
  return conn;
}

export async function syncContactToSalesforce(lifePlan: any): Promise<string> {
  const connection = await connectSalesforce();

  // Contactã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«é¡§å®¢æƒ…å ±ã‚’ä½œæˆ/æ›´æ–°
  const contact = {
    FirstName: lifePlan.clientName?.split(' ')[0] || '',
    LastName: lifePlan.clientName?.split(' ')[1] || '',
    Email: lifePlan.clientEmail || '',
    Phone: lifePlan.clientPhone || '',
    Birthdate: lifePlan.clientBirthdate || null,
    Annual_Income__c: lifePlan.data.annualIncome || 0, // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    Savings__c: lifePlan.data.currentSavings || 0, // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  };

  // æ—¢å­˜Contactã‚’æ¤œç´¢
  const existingContact = await connection.sobject('Contact').findOne({
    Email: contact.Email,
  });

  if (existingContact) {
    // æ›´æ–°
    await connection.sobject('Contact').update({
      Id: existingContact.Id,
      ...contact,
    });
    return existingContact.Id;
  } else {
    // æ–°è¦ä½œæˆ
    const result = await connection.sobject('Contact').create(contact);
    return result.id;
  }
}

export async function createOpportunityInSalesforce(
  contactId: string,
  lifePlanId: string,
  summary: string
): Promise<string> {
  const connection = await connectSalesforce();

  const opportunity = {
    Name: `ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ææ¡ˆ - ${lifePlanId}`,
    ContactId: contactId,
    StageName: 'Proposal',
    CloseDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30æ—¥å¾Œ
    Description: summary,
    Type: 'Financial Planning',
  };

  const result = await connection.sobject('Opportunity').create(opportunity);
  return result.id;
}

export async function logActivityInSalesforce(
  contactId: string,
  activityType: string,
  subject: string,
  description: string
): Promise<void> {
  const connection = await connectSalesforce();

  await connection.sobject('Task').create({
    WhoId: contactId,
    Subject: subject,
    Description: description,
    ActivityDate: new Date().toISOString().split('T')[0],
    Status: 'Completed',
    Priority: 'Normal',
  });
}
```

#### 2. HubSpot APIçµ±åˆ

```bash
npm install @hubspot/api-client
```

```typescript
// src/services/crm/hubspotService.ts
import { Client } from '@hubspot/api-client';

const hubspotClient = new Client({
  accessToken: import.meta.env.VITE_HUBSPOT_ACCESS_TOKEN || '',
});

export async function syncContactToHubSpot(lifePlan: any): Promise<string> {
  const properties = {
    email: lifePlan.clientEmail || '',
    firstname: lifePlan.clientName?.split(' ')[0] || '',
    lastname: lifePlan.clientName?.split(' ')[1] || '',
    phone: lifePlan.clientPhone || '',
    annual_income: lifePlan.data.annualIncome || 0,
    savings: lifePlan.data.currentSavings || 0,
  };

  try {
    // æ—¢å­˜Contactæ¤œç´¢
    const searchResult = await hubspotClient.crm.contacts.searchApi.doSearch({
      filterGroups: [
        {
          filters: [
            {
              propertyName: 'email',
              operator: 'EQ',
              value: properties.email,
            },
          ],
        },
      ],
    });

    if (searchResult.results.length > 0) {
      // æ›´æ–°
      const contactId = searchResult.results[0].id;
      await hubspotClient.crm.contacts.basicApi.update(contactId, { properties });
      return contactId;
    } else {
      // æ–°è¦ä½œæˆ
      const response = await hubspotClient.crm.contacts.basicApi.create({ properties });
      return response.id;
    }
  } catch (error) {
    console.error('Error syncing to HubSpot:', error);
    throw error;
  }
}

export async function createDealInHubSpot(
  contactId: string,
  lifePlanId: string,
  amount: number
): Promise<string> {
  const properties = {
    dealname: `ãƒ©ã‚¤ãƒ•ãƒ—ãƒ©ãƒ³ææ¡ˆ - ${lifePlanId}`,
    amount: amount.toString(),
    dealstage: 'presentationscheduled',
    pipeline: 'default',
  };

  const response = await hubspotClient.crm.deals.basicApi.create({
    properties,
    associations: [
      {
        to: { id: contactId },
        types: [{ associationCategory: 'HUBSPOT_DEFINED', associationTypeId: 3 }],
      },
    ],
  });

  return response.id;
}
```

#### 3. kintone APIçµ±åˆ

```typescript
// src/services/crm/kintoneService.ts
import axios from 'axios';

const KINTONE_DOMAIN = import.meta.env.VITE_KINTONE_DOMAIN || '';
const KINTONE_API_TOKEN = import.meta.env.VITE_KINTONE_API_TOKEN || '';
const KINTONE_APP_ID = import.meta.env.VITE_KINTONE_APP_ID || '';

const kintoneClient = axios.create({
  baseURL: `https://${KINTONE_DOMAIN}/k/v1/`,
  headers: {
    'X-Cybozu-API-Token': KINTONE_API_TOKEN,
    'Content-Type': 'application/json',
  },
});

export async function syncContactToKintone(lifePlan: any): Promise<string> {
  const record = {
    é¡§å®¢å: { value: lifePlan.clientName || '' },
    ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: { value: lifePlan.clientEmail || '' },
    é›»è©±ç•ªå·: { value: lifePlan.clientPhone || '' },
    å¹´å: { value: lifePlan.data.annualIncome?.toString() || '0' },
    è²¯è“„é¡: { value: lifePlan.data.currentSavings?.toString() || '0' },
  };

  try {
    // æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰æ¤œç´¢
    const searchResponse = await kintoneClient.get(`records.json`, {
      params: {
        app: KINTONE_APP_ID,
        query: `ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ = "${lifePlan.clientEmail}"`,
      },
    });

    if (searchResponse.data.records.length > 0) {
      // æ›´æ–°
      const recordId = searchResponse.data.records[0].$id.value;
      await kintoneClient.put('record.json', {
        app: KINTONE_APP_ID,
        id: recordId,
        record,
      });
      return recordId;
    } else {
      // æ–°è¦ä½œæˆ
      const response = await kintoneClient.post('record.json', {
        app: KINTONE_APP_ID,
        record,
      });
      return response.data.id;
    }
  } catch (error) {
    console.error('Error syncing to kintone:', error);
    throw error;
  }
}
```

#### 4. CRMçµ±åˆç®¡ç†UI

```typescript
// src/components/Settings/CRMIntegration.tsx
import { useState } from 'react';
import { supabase } from '@/lib/supabase';
import { useAuth } from '@/contexts/AuthContext';
import { useToast } from '@/hooks/useToast';

export function CRMIntegration() {
  const { user } = useAuth();
  const { showToast } = useToast();
  const [selectedCRM, setSelectedCRM] = useState<'salesforce' | 'hubspot' | 'kintone' | null>(null);
  const [apiKey, setApiKey] = useState('');
  const [domain, setDomain] = useState('');
  const [saving, setSaving] = useState(false);

  const handleSave = async () => {
    if (!user || !selectedCRM) return;

    setSaving(true);
    try {
      // CRMè¨­å®šã‚’ä¿å­˜ï¼ˆSupabase Vaultã«æš—å·åŒ–ä¿å­˜ï¼‰
      const { error } = await supabase.from('crm_integrations').upsert({
        user_id: user.id,
        crm_type: selectedCRM,
        api_key: apiKey,
        domain,
        enabled: true,
      });

      if (error) throw error;

      showToast('CRMé€£æºè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
    } catch (error) {
      console.error('Error saving CRM integration:', error);
      showToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold">CRMé€£æºè¨­å®š</h2>

      {/* CRMé¸æŠ */}
      <div className="grid grid-cols-3 gap-4">
        {['salesforce', 'hubspot', 'kintone'].map((crm) => (
          <button
            key={crm}
            onClick={() => setSelectedCRM(crm as any)}
            className={`p-6 border-2 rounded-lg ${
              selectedCRM === crm ? 'border-blue-500 bg-blue-50' : 'border-gray-300'
            }`}
          >
            <div className="text-4xl mb-2">
              {crm === 'salesforce' && 'â˜ï¸'}
              {crm === 'hubspot' && 'ğŸ”¶'}
              {crm === 'kintone' && 'ğŸŸ¦'}
            </div>
            <div className="font-semibold capitalize">{crm}</div>
          </button>
        ))}
      </div>

      {/* APIè¨­å®šãƒ•ã‚©ãƒ¼ãƒ  */}
      {selectedCRM && (
        <div className="p-6 border rounded-lg space-y-4">
          <h3 className="font-semibold text-lg capitalize">{selectedCRM} è¨­å®š</h3>

          {selectedCRM === 'kintone' && (
            <div>
              <label className="block text-sm font-medium mb-1">ãƒ‰ãƒ¡ã‚¤ãƒ³</label>
              <input
                type="text"
                value={domain}
                onChange={(e) => setDomain(e.target.value)}
                placeholder="your-domain.cybozu.com"
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>
          )}

          <div>
            <label className="block text-sm font-medium mb-1">
              {selectedCRM === 'salesforce' ? 'Access Token' : 'API Token'}
            </label>
            <input
              type="password"
              value={apiKey}
              onChange={(e) => setApiKey(e.target.value)}
              placeholder="APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›"
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>

          <button
            onClick={handleSave}
            disabled={saving}
            className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50"
          >
            {saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}
          </button>
        </div>
      )}
    </div>
  );
}
```

### âœ… å®Œäº†æ¡ä»¶

- [ ] Salesforce APIçµ±åˆ
- [ ] HubSpot APIçµ±åˆ
- [ ] kintone APIçµ±åˆ
- [ ] åŒæ–¹å‘åŒæœŸæ©Ÿèƒ½
- [ ] CRMè¨­å®šUI
- [ ] è‡ªå‹•åŒæœŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
- [ ] ãƒ†ã‚¹ãƒˆä½œæˆ

### ğŸ”§ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- jsforceï¼ˆSalesforceï¼‰
- @hubspot/api-clientï¼ˆHubSpotï¼‰
- Axiosï¼ˆkintoneï¼‰
- Supabaseï¼ˆè¨­å®šä¿å­˜ï¼‰

### ğŸ“ æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«

```
src/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ crm/
â”‚       â”œâ”€â”€ salesforceService.ts
â”‚       â”œâ”€â”€ hubspotService.ts
â”‚       â””â”€â”€ kintoneService.ts
â””â”€â”€ components/
    â””â”€â”€ Settings/
        â””â”€â”€ CRMIntegration.tsx

supabase/
â””â”€â”€ migrations/
    â””â”€â”€ 20260101_crm_integrations.sql
```

### ğŸš« ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå§”ä»»: ä¸å¯

**ç†ç”±**: å¤–éƒ¨APIçµ±åˆã®ä¸­æ ¸æ©Ÿèƒ½ã§ã‚ã‚Šã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒé‡è¦

---

## ISSUE-302: ãƒãƒ¼ãƒ æ©Ÿèƒ½ ğŸŸ¡ High

### ğŸ“‹ æ¦‚è¦

è¤‡æ•°FPã§ã®é¡§å®¢æƒ…å ±å…±æœ‰ã€å½¹å‰²ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆRBACï¼‰ã€æ‰¿èªãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

### ğŸ¯ ã‚¿ã‚¹ã‚¯è©³ç´°

#### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

```sql
-- organizations ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  plan_tier TEXT DEFAULT 'enterprise',
  max_members INTEGER DEFAULT 10,
  created_at TIMESTAMP DEFAULT NOW()
);

-- organization_members ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE organization_members (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role TEXT NOT NULL CHECK (role IN ('owner', 'admin', 'member', 'viewer')),
  joined_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(organization_id, user_id)
);

-- life_plan_shares ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆé¡§å®¢æƒ…å ±å…±æœ‰ï¼‰
CREATE TABLE life_plan_shares (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  life_plan_id UUID REFERENCES life_plans(id) ON DELETE CASCADE,
  shared_with_user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  permission TEXT NOT NULL CHECK (permission IN ('view', 'edit', 'admin')),
  shared_by_user_id UUID REFERENCES users(id),
  shared_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(life_plan_id, shared_with_user_id)
);

-- approval_requests ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ‰¿èªãƒ•ãƒ­ãƒ¼ï¼‰
CREATE TABLE approval_requests (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  life_plan_id UUID REFERENCES life_plans(id) ON DELETE CASCADE,
  requested_by_user_id UUID REFERENCES users(id),
  approved_by_user_id UUID REFERENCES users(id),
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
  comments TEXT,
  requested_at TIMESTAMP DEFAULT NOW(),
  reviewed_at TIMESTAMP
);
```

#### 2. RBACå®Ÿè£…

```typescript
// src/utils/rbac.ts
export type Role = 'owner' | 'admin' | 'member' | 'viewer';
export type Permission = 'view' | 'edit' | 'admin';

const ROLE_PERMISSIONS: Record<Role, Permission[]> = {
  owner: ['view', 'edit', 'admin'],
  admin: ['view', 'edit', 'admin'],
  member: ['view', 'edit'],
  viewer: ['view'],
};

export function hasPermission(role: Role, requiredPermission: Permission): boolean {
  return ROLE_PERMISSIONS[role].includes(requiredPermission);
}

export function canEditLifePlan(userRole: Role, lifePlanPermission: Permission): boolean {
  return (
    hasPermission(userRole, 'edit') &&
    (lifePlanPermission === 'edit' || lifePlanPermission === 'admin')
  );
}
```

#### 3. ãƒãƒ¼ãƒ ç®¡ç†UI

```typescript
// src/components/Team/TeamManagement.tsx
import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import { useAuth } from '@/contexts/AuthContext';

interface TeamMember {
  id: string;
  user_id: string;
  email: string;
  full_name: string;
  role: 'owner' | 'admin' | 'member' | 'viewer';
  joined_at: string;
}

export function TeamManagement() {
  const { user } = useAuth();
  const [members, setMembers] = useState<TeamMember[]>([]);
  const [inviteEmail, setInviteEmail] = useState('');
  const [inviteRole, setInviteRole] = useState<'admin' | 'member' | 'viewer'>('member');

  useEffect(() => {
    fetchMembers();
  }, []);

  const fetchMembers = async () => {
    // å®Ÿè£…
  };

  const handleInvite = async () => {
    // ãƒ¡ãƒ¼ãƒ«æ‹›å¾…æ©Ÿèƒ½
  };

  const handleRoleChange = async (memberId: string, newRole: string) => {
    // å½¹å‰²å¤‰æ›´
  };

  return (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold">ãƒãƒ¼ãƒ ç®¡ç†</h2>

      {/* ãƒ¡ãƒ³ãƒãƒ¼æ‹›å¾… */}
      <div className="p-4 border rounded-lg space-y-4">
        <h3 className="font-semibold">æ–°ã—ã„ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ‹›å¾…</h3>
        <div className="flex gap-2">
          <input
            type="email"
            value={inviteEmail}
            onChange={(e) => setInviteEmail(e.target.value)}
            placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"
            className="flex-1 px-3 py-2 border rounded-lg"
          />
          <select
            value={inviteRole}
            onChange={(e) => setInviteRole(e.target.value as any)}
            className="px-3 py-2 border rounded-lg"
          >
            <option value="admin">ç®¡ç†è€…</option>
            <option value="member">ãƒ¡ãƒ³ãƒãƒ¼</option>
            <option value="viewer">é–²è¦§ã®ã¿</option>
          </select>
          <button
            onClick={handleInvite}
            className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            æ‹›å¾…
          </button>
        </div>
      </div>

      {/* ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ */}
      <div className="space-y-2">
        <h3 className="font-semibold">ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆ{members.length}åï¼‰</h3>
        {members.map((member) => (
          <div key={member.id} className="p-4 border rounded-lg flex justify-between items-center">
            <div>
              <h4 className="font-semibold">{member.full_name}</h4>
              <p className="text-sm text-gray-600">{member.email}</p>
            </div>
            <select
              value={member.role}
              onChange={(e) => handleRoleChange(member.id, e.target.value)}
              className="px-3 py-1 border rounded"
              disabled={member.role === 'owner'}
            >
              <option value="owner">ã‚ªãƒ¼ãƒŠãƒ¼</option>
              <option value="admin">ç®¡ç†è€…</option>
              <option value="member">ãƒ¡ãƒ³ãƒãƒ¼</option>
              <option value="viewer">é–²è¦§ã®ã¿</option>
            </select>
          </div>
        ))}
      </div>
    </div>
  );
}
```

### âœ… å®Œäº†æ¡ä»¶

- [ ] çµ„ç¹”ãƒ»ãƒ¡ãƒ³ãƒãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ
- [ ] RBACå®Ÿè£…
- [ ] ãƒãƒ¼ãƒ ç®¡ç†UI
- [ ] ãƒ¡ãƒ³ãƒãƒ¼æ‹›å¾…æ©Ÿèƒ½
- [ ] æ‰¿èªãƒ•ãƒ­ãƒ¼å®Ÿè£…
- [ ] RLSï¼ˆRow Level Securityï¼‰è¨­å®š
- [ ] ãƒ†ã‚¹ãƒˆä½œæˆ

### âœ… ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå§”ä»»: å¯èƒ½

---

## ISSUE-303: ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹æ©Ÿèƒ½ ğŸ”´ Critical

### ğŸ“‹ æ¦‚è¦

ç›£æŸ»ãƒ­ã‚°ã€é‡‘èåºè¦åˆ¶å¯¾å¿œã€é©åˆæ€§åŸå‰‡ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

*(å®Ÿè£…è©³ç´°ã¯çœç•¥)*

### âœ… å®Œäº†æ¡ä»¶

- [ ] ç›£æŸ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ
- [ ] å…¨æ“ä½œãƒ­ã‚°è¨˜éŒ²
- [ ] é‡‘èåºè¦åˆ¶ãƒ¬ãƒãƒ¼ãƒˆ
- [ ] é©åˆæ€§åŸå‰‡ãƒã‚§ãƒƒã‚¯
- [ ] ãƒ­ã‚°é–²è¦§UI

### ğŸš« ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå§”ä»»: ä¸å¯

---

## ISSUE-304: é‡‘èå•†å“DB ğŸŸ¡ High

### ğŸ“‹ æ¦‚è¦

ç”Ÿå‘½ä¿é™ºãƒ»åŒ»ç™‚ä¿é™ºãƒ»æŠ•è³‡ä¿¡è¨—ãƒ»iDeCoãƒ»NISAã®å•†å“ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

*(å®Ÿè£…è©³ç´°ã¯çœç•¥)*

### âœ… å®Œäº†æ¡ä»¶

- [ ] å•†å“DBãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ
- [ ] å•†å“æ¤œç´¢æ©Ÿèƒ½
- [ ] ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é€£æº
- [ ] ç¨åˆ¶å„ªé‡è¨ˆç®—
- [ ] å•†å“ç®¡ç†UI

### âœ… ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå§”ä»»: å¯èƒ½

---

## ISSUE-305: ãƒ›ãƒ¯ã‚¤ãƒˆãƒ©ãƒ™ãƒ«å¯¾å¿œ ğŸŸ¢ Medium

### ğŸ“‹ æ¦‚è¦

ä¼æ¥­ãƒ–ãƒ©ãƒ³ãƒ‰ã§ã®æä¾›ã€ãƒ­ã‚´ãƒ»ã‚«ãƒ©ãƒ¼ãƒ†ãƒ¼ãƒã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã€ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã‚’å®Ÿè£…ã—ã¾ã™ã€‚

*(å®Ÿè£…è©³ç´°ã¯çœç•¥)*

### âœ… å®Œäº†æ¡ä»¶

- [ ] ãƒ–ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°è¨­å®šDB
- [ ] ãƒ­ã‚´ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
- [ ] ã‚«ãƒ©ãƒ¼ãƒ†ãƒ¼ãƒã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
- [ ] ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š
- [ ] PDFãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### âœ… ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå§”ä»»: å¯èƒ½

---

## ğŸ“ Phase 3å®Œäº†å¾Œã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] å…¨5 Issueã‚¯ãƒ­ãƒ¼ã‚º
- [ ] ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºæ©Ÿèƒ½çµ±åˆãƒ†ã‚¹ãƒˆ
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
- [ ] æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºç‰ˆãƒªãƒªãƒ¼ã‚¹
- [ ] ä¼æ¥­é¡§å®¢10ç¤¾ç²å¾—
- [ ] MRR Â¥4,770,000é”æˆ
- [ ] SLA 99.9%é”æˆ
- [ ] NPS 60ä»¥ä¸Š

---

## ğŸ‰ å…¨Phaseå®Œäº†å¾Œã®æœ€çµ‚ç›®æ¨™

### 3å¹´å¾Œã®åˆ°é”ç‚¹

| æŒ‡æ¨™ | ç›®æ¨™ | èª¬æ˜ |
|------|------|------|
| **ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°** | 6,510å | ç„¡æ–™5,000 + ãƒ©ã‚¤ãƒˆ800 + ãƒ—ãƒ­700 + ä¼æ¥­10ç¤¾ |
| **å¹´é–“å£²ä¸Šï¼ˆARRï¼‰** | Â¥148,800,000 | æœˆæ¬¡MRR Â¥12,400,000 Ã— 12ãƒ¶æœˆ |
| **ç´”åˆ©ç›Š** | +Â¥75,000,000 | å£²ä¸Š - è²»ç”¨ï¼ˆé–‹ç™ºè²»+ãƒãƒ¼ã‚±è²»ï¼‰ |
| **å¸‚å ´ã‚·ã‚§ã‚¢** | Top 3 | å›½å†…FPãƒ„ãƒ¼ãƒ«å¸‚å ´ã§ãƒˆãƒƒãƒ—3å…¥ã‚Š |
| **NPS** | 60ä»¥ä¸Š | é¡§å®¢æº€è¶³åº¦ãƒ»æ¨å¥¨åº¦ |

**Next Step**: ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºå–¶æ¥­ãƒ»å›½éš›å±•é–‹ãƒ»M&Aæ¤œè¨

---

**å‰Phase**: [PHASE2_TIER2_ISSUES.md](./PHASE2_TIER2_ISSUES.md)
