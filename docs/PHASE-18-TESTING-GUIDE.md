# 📋 Phase 18 手動テストガイド

Phase 18（Freemium戦略実装）の手動テスト手順書です。

---

## 🎯 テスト目的

3段階のFreemium機能が正しく動作することを確認：
1. **Tier 1（匿名）**: 基本機能のみ利用可能、登録CTAが表示される
2. **Tier 2（登録済み）**: 繰上返済とローン比較が解放、Premium CTAが表示される
3. **Tier 3（Premium）**: 全機能解放、FPツールとPDF出力が利用可能

---

## 🌐 テスト環境

- **開発サーバー**: http://localhost:5174/
- **Supabase**: 設定済み（.env ファイル確認済み）
- **認証方法**: Email/Passwordのみ（OAuth一時無効化）

---

## ⚠️ 事前準備

### 1. 開発サーバー起動確認

```bash
# ターミナルで確認
ps aux | grep vite | grep -v grep
```

**期待結果**: Viteプロセスが実行中であること

### 2. ブラウザを開く

推奨ブラウザ: Chrome / Edge / Safari（最新版）

```
URL: http://localhost:5174/
```

### 3. ブラウザのDevToolsを開く

- **F12** または **Cmd+Option+I**（Mac）
- **Console** タブで警告・エラーをチェック

### 4. localStorage をクリア（クリーンな状態でテスト）

```javascript
// ブラウザのConsoleで実行
localStorage.clear();
location.reload();
```

---

## 🧪 テストケース

### 📌 Test 1: Tier 1（匿名ユーザー）の基本動作

#### 1.1 ホーム画面の確認

**手順:**
1. http://localhost:5174/ にアクセス
2. ヘッダーの「新規登録」「ログイン」ボタンを確認

**期待結果:**
- ✅ ヘッダーに「新規登録」「ログイン」ボタンが表示される
- ✅ 右上に「ログイン」が表示される（ログアウト状態）

#### 1.2 住宅ローン計算機の動作確認

**手順:**
1. 借入額: 5000万円
2. 金利: 1.0%
3. 返済期間: 40年
4. 「計算する」をクリック

**期待結果:**
- ✅ 月々の返済額が表示される（約133,000円）
- ✅ 返済スケジュール表が表示される
- ✅ 計算結果が表示される

#### 1.3 逆算機能の動作確認

**手順:**
1. ヘッダーの「返済額から計算」をクリック
2. 月々の返済額: 15万円
3. 金利: 1.0%
4. 返済期間: 40年
5. 「計算する」をクリック

**期待結果:**
- ✅ 借入可能額が表示される（約5,600万円）
- ✅ 計算結果が表示される

#### 1.4 簡易電卓の動作確認

**手順:**
1. ヘッダーの「電卓」タブをクリック
2. "1 + 1 =" を入力

**期待結果:**
- ✅ 結果: 2 が表示される
- ✅ 計算履歴に "1 + 1 = 2" が表示される

#### 1.5 繰上返済のロック確認（重要！）

**手順:**
1. ヘッダーの「繰上返済」をクリック

**期待結果:**
- ✅ 画面全体が薄いオーバーレイで覆われる
- ✅ 「この機能を使用するには無料アカウント登録が必要です」というメッセージが表示される
- ✅ 「今すぐ無料登録」ボタンが表示される
- ✅ ボタンをクリックすると `/signup` ページに遷移する

#### 1.6 ローン比較のロック確認

**手順:**
1. ヘッダーの「ローン比較」をクリック

**期待結果:**
- ✅ 同様のロック画面が表示される
- ✅ 「今すぐ無料登録」ボタンが表示される

#### 1.7 FP機能のロック確認

**手順:**
1. ヘッダーの「ライフプラン」をクリック
2. 「家計収支」「資産運用」「保険設計」も同様に確認

**期待結果:**
- ✅ 全てのFP機能に「Premium限定」バッジが表示される
- ✅ 「この機能はPremiumプラン（月額¥980）の会員限定です」というメッセージが表示される
- ✅ 「Premiumプランを見る」ボタンが表示される

---

### 📌 Test 2: 新規登録（Email/Password）

#### 2.1 新規登録画面への遷移

**手順:**
1. ヘッダーの「新規登録」をクリック

**期待結果:**
- ✅ `/signup` ページに遷移する
- ✅ 「住宅ローン電卓」タイトルが表示される
- ✅ 「新規アカウント作成」サブタイトルが表示される

#### 2.2 OAuth ボタンが非表示

**確認:**
- ✅ GoogleログインボタンとAppleログインボタンが表示されない
- ✅ 「または」セパレーターも表示されない
- ✅ Email/Passwordフォームのみ表示される

#### 2.3 バリデーション確認

**手順:**
1. すべての項目を空欄のまま「アカウント作成」をクリック

**期待結果:**
- ✅ エラートースト: 「すべての項目を入力してください」が表示される

**手順:**
2. パスワード不一致
   - Email: test@example.com
   - パスワード: password123
   - パスワード（確認）: password456
   - 「アカウント作成」をクリック

**期待結果:**
- ✅ エラートースト: 「パスワードが一致しません」が表示される

**手順:**
3. パスワード短すぎる
   - Email: test@example.com
   - パスワード: pass
   - パスワード（確認）: pass
   - 「アカウント作成」をクリック

**期待結果:**
- ✅ エラートースト: 「パスワードは6文字以上で入力してください」が表示される

#### 2.4 正常登録

**手順:**
1. 表示名（任意）: テストユーザー
2. Email: test123@example.com ※ 既存でないアドレス
3. パスワード: test1234
4. パスワード（確認）: test1234
5. 「アカウント作成」をクリック

**期待結果:**
- ✅ 成功トースト: 「アカウントを作成しました。確認メールをご確認ください。」が表示される
- ✅ `/login` ページに自動遷移する

**注意:**
- Supabaseの設定で確認メール機能が有効な場合、メールが送信される可能性あり
- テスト環境では確認メールなしでもログイン可能な場合が多い

---

### 📌 Test 3: ログイン

#### 3.1 ログイン画面への遷移

**手順:**
1. ヘッダーの「ログイン」をクリック（または新規登録後に自動遷移）

**期待結果:**
- ✅ `/login` ページに遷移する
- ✅ 「住宅ローン電卓」タイトルが表示される
- ✅ 「アカウントにログイン」サブタイトルが表示される

#### 3.2 OAuth ボタンが非表示

**確認:**
- ✅ GoogleログインボタンとAppleログインボタンが表示されない
- ✅ Email/Passwordフォームのみ表示される

#### 3.3 ログイン実行

**手順:**
1. Email: test123@example.com ※ 先ほど登録したアドレス
2. パスワード: test1234
3. 「ログイン」をクリック

**期待結果:**
- ✅ 成功トースト: 「ログインしました」が表示される
- ✅ ホーム画面 `/` に自動遷移する
- ✅ ヘッダーの「ログイン」ボタンが「ログアウト」に変わる
- ✅ 右上に「アカウント」メニューが表示される（任意）

---

### 📌 Test 4: Tier 2（登録ユーザー）の機能解放

#### 4.1 繰上返済のアクセス確認

**手順:**
1. ヘッダーの「繰上返済」をクリック

**期待結果:**
- ✅ ロック画面が表示されない（機能が解放される）
- ✅ 繰上返済シミュレーション画面が表示される
- ✅ 繰上返済額入力フォームが表示される

#### 4.2 繰上返済の計算実行

**手順:**
1. 繰上返済額: 500万円
2. 繰上時期: 5年後
3. 返済方法: 期間短縮型
4. 「シミュレーション実行」をクリック

**期待結果:**
- ✅ 短縮後の返済期間が表示される
- ✅ 利息軽減額が表示される
- ✅ 計算結果が表示される

#### 4.3 ローン比較のアクセス確認

**手順:**
1. ヘッダーの「ローン比較」をクリック

**期待結果:**
- ✅ ロック画面が表示されない（機能が解放される）
- ✅ ローン比較画面が表示される
- ✅ 「ローン追加」ボタンが表示される

#### 4.4 ローン比較の実行

**手順:**
1. 「ローン追加」をクリック
2. ローンA: 5000万円, 1.0%, 40年
3. 「ローン追加」をクリック
4. ローンB: 5000万円, 0.8%, 40年
5. 比較表を確認

**期待結果:**
- ✅ 2つのローンが横並びで比較される
- ✅ 月々返済額の差が表示される
- ✅ 総返済額の差が表示される
- ✅ どちらがお得かが視覚的にわかる

#### 4.5 FP機能のロック確認（まだロックされている）

**手順:**
1. ヘッダーの「ライフプラン」をクリック

**期待結果:**
- ✅ まだロック画面が表示される
- ✅ 「この機能はPremiumプラン（月額¥980）の会員限定です」が表示される
- ✅ 「Premiumプランを見る」ボタンが表示される

#### 4.6 PDF出力のクォータ確認

**手順:**
1. ローン計算結果画面で「PDF出力」ボタンをクリック

**期待結果:**
- ✅ PDFダウンロードが開始される
- ✅ PDFを開くと、全ページに「TRIAL VERSION」の透かしが入っている
- ✅ トースト: 「PDF出力: 1/3回 残り2回」が表示される

**手順:**
2. もう一度「PDF出力」ボタンをクリック

**期待結果:**
- ✅ トースト: 「PDF出力: 2/3回 残り1回」が表示される

**手順:**
3. もう一度「PDF出力」ボタンをクリック

**期待結果:**
- ✅ トースト: 「PDF出力: 3/3回 残り0回」が表示される

**手順:**
4. もう一度「PDF出力」ボタンをクリック（クォータ超過）

**期待結果:**
- ✅ エラートースト: 「月3回の制限に達しました。Premiumプランにアップグレードすると無制限で利用できます。」が表示される
- ✅ PDFダウンロードは開始されない

---

### 📌 Test 5: クラウド履歴同期（Tier 2）

#### 5.1 localStorage 履歴の確認

**手順:**
1. ブラウザのConsoleを開く
2. 以下のコードを実行:
```javascript
JSON.parse(localStorage.getItem('loan-calculator-history') || '[]')
```

**期待結果:**
- ✅ 配列が表示される（ログイン前の計算履歴）

#### 5.2 履歴ページでの同期確認

**手順:**
1. ヘッダーの「履歴」をクリック
2. 履歴一覧を確認

**期待結果:**
- ✅ ログイン前の履歴（localStorage）とSupabaseの履歴が統合されて表示される
- ✅ 新しい順に並んでいる
- ✅ 各履歴に日時・借入額・返済額が表示される

#### 5.3 新規計算の自動保存

**手順:**
1. ホーム画面に戻る
2. 新しい計算を実行（例：3000万円、35年、1.5%）
3. 履歴ページに戻る

**期待結果:**
- ✅ 新しい計算結果が履歴の一番上に追加される
- ✅ Supabaseにも自動保存される（ページリロード後も残る）

#### 5.4 ページリロード後の永続化確認

**手順:**
1. ブラウザをリロード（F5 または Cmd+R）
2. 履歴ページを開く

**期待結果:**
- ✅ 同じ履歴が表示される（消えていない）
- ✅ Supabaseから取得された履歴が表示される

---

### 📌 Test 6: Premium機能のロック確認（Tier 2でまだロック）

#### 6.1 ライフプランシミュレーション

**手順:**
1. ヘッダーの「ライフプラン」をクリック

**期待結果:**
- ✅ ロック画面が表示される
- ✅ 「Premium限定」バッジが表示される
- ✅ 「Premiumプランを見る」ボタンが表示される
- ✅ ボタンをクリックすると `/pricing` ページに遷移する

#### 6.2 家計収支シミュレーション

**手順:**
1. ヘッダーの「家計収支」をクリック

**期待結果:**
- ✅ 同様のロック画面が表示される

#### 6.3 資産運用シミュレーション

**手順:**
1. ヘッダーの「資産運用」をクリック

**期待結果:**
- ✅ 同様のロック画面が表示される

#### 6.4 保険設計シミュレーション

**手順:**
1. ヘッダーの「保険設計」をクリック

**期待結果:**
- ✅ 同様のロック画面が表示される

---

### 📌 Test 7: Premium CTA の確認

#### 7.1 ホーム画面のCTA

**手順:**
1. ホーム画面に戻る
2. スクロールして画面下部を確認

**期待結果:**
- ✅ 「Premiumプランでさらに便利に！」というCTAセクションが表示される
- ✅ 金色のグラデーション背景が表示される
- ✅ FP機能のリスト（ライフプラン・家計収支・資産運用・保険設計）が表示される
- ✅ 「月額¥980」の価格が表示される
- ✅ 「Premiumプランを見る」ボタンが表示される

#### 7.2 CTAボタンのリンク確認

**手順:**
1. 「Premiumプランを見る」ボタンをクリック

**期待結果:**
- ✅ `/pricing` ページに遷移する
- ✅ 料金プラン比較表が表示される

---

### 📌 Test 8: ログアウト

#### 8.1 ログアウト実行

**手順:**
1. ヘッダーの「ログアウト」ボタンをクリック

**期待結果:**
- ✅ トースト: 「ログアウトしました」が表示される
- ✅ ホーム画面 `/` にリダイレクトされる
- ✅ ヘッダーの「ログアウト」ボタンが「ログイン」に変わる

#### 8.2 機能のロック確認（Tier 1 に戻る）

**手順:**
1. 「繰上返済」をクリック
2. 「ローン比較」をクリック

**期待結果:**
- ✅ 両方ともロック画面が表示される
- ✅ 「今すぐ無料登録」ボタンが表示される

---

### 📌 Test 9: localStorage のクリーンアップ

#### 9.1 PDF出力クォータのリセット確認

**手順:**
1. 再度ログイン（test123@example.com / test1234）
2. ブラウザのConsoleを開く
3. 以下のコードを実行（月初を再現）:
```javascript
localStorage.removeItem('pdf-quota-month');
localStorage.removeItem('pdf-quota-count');
location.reload();
```
4. ローン計算結果画面で「PDF出力」ボタンをクリック

**期待結果:**
- ✅ トースト: 「PDF出力: 1/3回 残り2回」が表示される（リセットされている）

---

## 🚨 既知の問題と対処法

### 問題1: OAuth ボタンが表示されている

**症状**: GoogleログインやAppleログインボタンが表示される

**原因**: コードが最新でない可能性

**対処法**:
```bash
# ターミナルで実行
git pull origin main
npm install
# 開発サーバーを再起動
```

### 問題2: Supabase エラー「session not found」

**症状**: ログイン後に「session not found」エラーが表示される

**原因**: Supabaseの認証設定が不完全

**対処法**:
1. Supabase Dashboard → Authentication → Settings
2. 「Disable email confirmations」をONにする（テスト環境のみ）
3. ログアウト → 再ログイン

### 問題3: PDF出力が動作しない

**症状**: 「PDF出力」ボタンをクリックしても何も起こらない

**原因**: jsPDF / html2canvas のロードエラー

**対処法**:
```bash
npm install jspdf html2canvas
npm run dev
```

### 問題4: 履歴が同期されない

**症状**: ページリロード後に履歴が消える

**原因**: Supabase RLSポリシーが未設定

**対処法**:
1. `docs/PHASE-18-SUMMARY.md` の「データベーススキーマ」セクションを参照
2. Supabase SQL Editorでマイグレーションを実行:
```sql
-- RLSポリシーを確認
SELECT * FROM pg_policies WHERE tablename = 'loan_history';
```

---

## ✅ テスト完了チェックリスト

### Tier 1（匿名）
- [ ] ホーム画面が正常に表示される
- [ ] 住宅ローン計算機が動作する
- [ ] 逆算機能が動作する
- [ ] 簡易電卓が動作する
- [ ] 繰上返済がロックされている
- [ ] ローン比較がロックされている
- [ ] FP機能がすべてロックされている

### Tier 2（登録済み）
- [ ] 新規登録が成功する
- [ ] ログインが成功する
- [ ] 繰上返済が解放される
- [ ] ローン比較が解放される
- [ ] FP機能はまだロックされている
- [ ] PDF出力に透かしが入る
- [ ] PDF出力クォータが機能する（月3回）
- [ ] クラウド履歴同期が動作する
- [ ] ページリロード後も履歴が残る

### Tier 3（Premium）
- [ ] Premiumプラン登録画面が表示される（`/pricing`）
- [ ] ※ Stripe統合後にテスト予定

### UI/UX
- [ ] FeatureGateのロック画面が美しく表示される
- [ ] CTAボタンが目立つ（金色グラデーション）
- [ ] トーストメッセージが適切に表示される
- [ ] レスポンシブデザインが機能する（モバイル/タブレット/PC）

---

## 📝 バグ報告フォーマット

もしバグを発見した場合、以下の形式で報告してください：

```markdown
### バグタイトル

**発生箇所**: ページ名 / コンポーネント名

**再現手順**:
1. ...
2. ...
3. ...

**期待される動作**:
...

**実際の動作**:
...

**スクリーンショット**:
（可能であれば）

**環境**:
- ブラウザ: Chrome 120.0 / Safari 17.0 など
- OS: macOS 14.0 / Windows 11 など
- デバイス: PC / Tablet / Mobile
```

---

## 🎉 テスト完了後

すべてのテストケースをパスしたら、以下を実行してください：

```bash
# TypeScript型チェック
npm run type-check

# Lint チェック
npm run lint

# ユニットテスト実行
npm run test -- --run

# プロダクションビルド
npm run build
```

すべてエラーなく完了すれば、Phase 18 は完成です！🚀

---

**次のステップ**: Phase 19（Advanced Features - AI機能、ホワイトラベル対応）の計画を開始します。
