# 返済負担率計算機能 - 機能仕様書

## 📋 概要

**機能名**: 返済負担率から借入可能額を計算

**目的**: ユーザーが希望する返済負担率（年収に対する返済額の割合）から、無理のない借入可能額を計算する機能

**対象ユーザー**:
- **無料版**: 返済負担率25%固定で計算
- **有料版（メール登録）**: 複数の返済負担率（20%, 25%, 30%など）で比較

---

## 🎯 機能要件

### パターン1: 無料版（未登録ユーザー）

#### 入力項目
1. **本人年収**（必須）
   - 単位: 万円
   - 入力方法: 直接キーボード入力可能
   - デフォルト値: 空欄またはプレースホルダー「例：500」
   - 範囲: 1万円〜9999万円

2. **連帯債務者年収**（任意）
   - 単位: 万円
   - 入力方法: 直接キーボード入力可能
   - デフォルト値: 空欄（未入力時は0として扱う）
   - 範囲: 0万円〜9999万円
   - 説明: 配偶者など、共同で返済する方の年収

3. **返済負担率**（固定）
   - 値: **25%**（固定、変更不可）
   - 表示: 「返済負担率: 25%（推奨）」

4. **金利**（必須）
   - 単位: %（年利）
   - デフォルト値: 1.0%
   - 範囲: 0.01%〜10.0%

5. **返済期間**（必須）
   - 単位: 年
   - デフォルト値: 35年
   - 範囲: 1年〜50年

#### 計算ロジック

```
Step 1: 合算年収の計算
  合算年収 = 本人年収 + 連帯債務者年収

Step 2: 年間返済可能額の計算
  年間返済可能額 = 合算年収 × 25%

Step 3: 月々返済可能額の計算
  月々返済可能額 = 年間返済可能額 ÷ 12ヶ月

Step 4: 借入可能額を逆算
  元利均等返済の逆算公式を使用:
  P = PMT × [(1 + r)^n - 1] / [r × (1 + r)^n]

  P: 借入可能額（元金）
  PMT: 月々返済額
  r: 月利（年利 ÷ 12 ÷ 100）
  n: 総返済回数（年数 × 12）
```

#### 出力項目
1. **借入可能額**（万円単位で表示）
2. **月々返済額**（円単位で表示）
3. **年間返済額**（円単位で表示）
4. **総返済額**（円単位で表示）
5. **利息総額**（円単位で表示）

#### UI配置
- **既存の年収ベース計算と統合**するか、**別モード**として追加
- Homeページの「年収」モード内に追加タブまたはトグルで切り替え

---

### パターン2: 有料版（メール登録ユーザー）

#### 追加機能
1. **複数の返済負担率で比較**
   - 比較対象: 20%, 25%, 30%（デフォルト）
   - カスタマイズ: ユーザーが自由に設定可能（10%〜50%）

2. **比較表示（同一画面）**
   - 表形式またはカード形式で並べて表示
   - 各返済負担率ごとに：
     - 借入可能額
     - 月々返済額
     - 年間返済額
     - 総返済額
     - 利息総額

#### UI例（表形式）

```
┌─────────────┬──────────┬──────────┬──────────┐
│ 返済負担率  │   20%    │   25%    │   30%    │
├─────────────┼──────────┼──────────┼──────────┤
│ 借入可能額  │ 3,500万円│ 4,375万円│ 5,250万円│
│ 月々返済額  │  83,333円│ 104,166円│ 125,000円│
│ 年間返済額  │ 100万円  │ 125万円  │ 150万円  │
│ 総返済額    │ 3,850万円│ 4,812万円│ 5,775万円│
│ 利息総額    │  350万円 │  437万円 │  525万円 │
└─────────────┴──────────┴──────────┴──────────┘
```

---

## 🔄 既存機能との関係

### ローン計算の4つのモード

Homeページの「ローン計算」には4つの計算モードがあります：

```
┌──────────┬──────────┬──────────┬──────────┐
│ 借入額   │ 返済額   │返済負担率│ 年収MAX  │
│ (forward)│ (reverse)│ (ratio)  │ (income) │
└──────────┴──────────┴──────────┴──────────┘
```

#### 1. 借入額から計算（forward）
**入力**: 借入額、金利、返済期間
**出力**: 月々返済額、総返済額
**用途**: 「この金額を借りたら、月々いくら返済？」

#### 2. 返済額から計算（reverse）
**入力**: 月々返済額、金利、返済期間
**出力**: 借入可能額、総返済額
**用途**: 「月々○○円返せるなら、いくら借りられる？」

#### 3. 返済負担率から計算（repayment-ratio）← **新機能**
**入力**: 本人年収、連帯債務者年収（任意）、返済負担率25%、金利、返済期間
**出力**: 借入可能額、月々返済額、総返済額
**用途**: 「年収から、無理のない借入額は？」
**特徴**: 返済負担率25%固定で安全な返済計画

#### 4. 年収MAX借入（income）
**入力**: 本人年収、連帯債務者/保証人、金利、返済期間
**出力**: MAX借入可能額（30%/35%自動判定）
**用途**: 「年収から、最大いくらまで借りられる？」
**特徴**: 金融機関基準の上限額を表示（アンカリング効果）

---

### 配置イメージ

```
住宅ローン電卓
├─ ローン計算（viewMode: 'loan'）
│  ├─ 借入額（calculationMode: 'forward'）
│  ├─ 返済額（calculationMode: 'reverse'）
│  ├─ 返済負担率（calculationMode: 'repayment-ratio'）← 新規追加
│  └─ 年収MAX（calculationMode: 'income'）
├─ 電卓（viewMode: 'calculator'）
└─ 資産運用（viewMode: 'investment'）
```

---

### 返済負担率 vs 年収MAX の違い

| 項目 | 返済負担率（新機能） | 年収MAX（既存） |
|------|---------------------|----------------|
| **返済負担率** | 25%固定 | 30%/35%自動判定 |
| **コンセプト** | 安全・無理のない返済 | 最大限借りる |
| **連帯債務者** | 100%合算のみ | 100%合算 or 50%合算 |
| **対象ユーザー** | 慎重派・一般ユーザー | 営業・最大額知りたい人 |
| **位置づけ** | 独立した計算モード | 独立した計算モード |

**重要**: 2つは完全に別の機能として並列で存在します。統合はしません。

---

## 🎨 UI/UXデザイン

### 無料版 UI

```
┌─────────────────────────────────────┐
│  返済負担率から借入可能額を計算      │
├─────────────────────────────────────┤
│                                     │
│  本人年収 *                         │
│  [________] 万円  ▲ ▼              │
│                                     │
│  連帯債務者年収（任意）              │
│  [________] 万円  ▲ ▼              │
│  ※ 配偶者など共同で返済する方の年収 │
│                                     │
│  返済負担率                          │
│  ┌──────────────────────┐          │
│  │  25% （推奨）         │          │
│  └──────────────────────┘          │
│  ※ 無理のない返済計画の目安です     │
│                                     │
│  金利（年利）                        │
│  [_1.0_] %  ▲ ▼                    │
│                                     │
│  返済期間                            │
│  [_35_] 年  ▲ ▼                    │
│                                     │
│  [  計算する  ]                     │
│                                     │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  💰 計算結果                        │
├─────────────────────────────────────┤
│  借入可能額: 4,375万円              │
│  月々返済額: 104,166円              │
│  年間返済額: 1,250,000円            │
│  総返済額: 48,125,000円             │
│  利息総額: 4,375,000円              │
└─────────────────────────────────────┘
```

### 有料版 UI（比較モード）

```
┌─────────────────────────────────────┐
│  📊 返済負担率比較                  │
├─────────────────────────────────────┤
│  返済負担率を選択（複数選択可）      │
│  ☑ 20%  ☑ 25%  ☑ 30%              │
│  ☐ カスタム: [__]%                 │
│                                     │
│  [  比較する  ]                     │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  比較結果                            │
├────────┬──────┬──────┬──────────┤
│        │ 20%  │ 25%  │ 30%      │
├────────┼──────┼──────┼──────────┤
│借入可能│3,500 │4,375 │5,250     │
│月々返済│83,333│104,166│125,000  │
│年間返済│100万 │125万 │150万     │
│総返済額│3,850 │4,812 │5,775     │
│利息総額│ 350  │ 437  │ 525      │
└────────┴──────┴──────┴──────────┘

💡 推奨: 25%以下が無理のない返済計画です
```

---

## 🧮 計算例

### ケース1: 単独（本人のみ）

**入力**:
- 本人年収: 500万円
- 連帯債務者年収: 0万円（未入力）
- 返済負担率: 25%
- 金利: 1.0%
- 返済期間: 35年

**計算**:
```
合算年収 = 500万円
年間返済可能額 = 500万円 × 25% = 125万円
月々返済可能額 = 125万円 ÷ 12 = 104,166円
借入可能額 = 逆算により約 4,375万円
```

### ケース2: 連帯債務者あり

**入力**:
- 本人年収: 400万円
- 連帯債務者年収: 300万円
- 返済負担率: 25%
- 金利: 1.0%
- 返済期間: 35年

**計算**:
```
合算年収 = 400万円 + 300万円 = 700万円
年間返済可能額 = 700万円 × 25% = 175万円
月々返済可能額 = 175万円 ÷ 12 = 145,833円
借入可能額 = 逆算により約 6,125万円
```

---

## 🔐 機能制限（無料版 vs 有料版）

| 機能 | 無料版 | 有料版 |
|------|--------|--------|
| 返済負担率25%計算 | ✅ | ✅ |
| 複数返済負担率比較 | ❌ | ✅ |
| カスタム返済負担率 | ❌ | ✅ |
| PDF出力 | ❌ | ✅ |
| 計算履歴クラウド保存 | ❌ | ✅ |

---

## 📱 レスポンシブ対応

- **PC**: 横並び表示（入力欄と結果を左右に配置）
- **タブレット**: 縦並び表示
- **スマホ**: 縦並び表示、入力欄を大きく

---

## 🧪 テストケース

### 正常系
1. 本人年収のみで計算
2. 連帯債務者ありで計算
3. 金利0.5%〜3.0%で計算
4. 返済期間10年〜50年で計算

### 異常系
1. 年収が未入力（エラー表示）
2. 年収が0円（エラー表示）
3. 金利が0%（警告表示）
4. 返済期間が0年（エラー表示）

### 境界値
1. 年収1万円
2. 年収9999万円
3. 金利0.01%
4. 返済期間1年
5. 返済期間50年

---

## 🚀 実装優先度

### Phase 1: 無料版（高優先度）
- 返済負担率25%固定計算
- 本人年収 + 連帯債務者年収（任意）
- 基本的な入力UI
- 結果表示

### Phase 2: 有料版（中優先度）
- 複数返済負担率比較（20%, 25%, 30%）
- 比較表示UI
- カスタム返済負担率入力

### Phase 3: 拡張機能（低優先度）
- グラフ表示
- PDF出力
- おすすめ返済負担率の提案

---

## 📚 参考資料

### 業界標準の返済負担率
- **フラット35**: 年収400万円未満→30%、400万円以上→35%
- **一般的な推奨値**: 20%〜25%（無理のない返済）
- **ギリギリの上限**: 30%〜35%

### 既存機能との使い分け
- **MAX借入額計算**: 「最大いくらまで借りられるか？」（営業向け）
- **返済負担率計算**: 「無理なく返せる金額は？」（ユーザー向け）

---

**作成日**: 2025-10-31
**更新日**: 2025-10-31
**バージョン**: 1.0
