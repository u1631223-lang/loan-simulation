# 📊 年収ベースMAX借入額計算機能

## 🎯 目的

**心理学的アンカリング効果の活用**:
- ユーザーに「借入可能な最大額」を先に提示
- 高い金額をアンカーとして認識させる
- その後、実際のローン計算で現実的な返済額を検討
- → 「これだけ借りられる」から「これなら返せる」への意識転換

---

## 📋 機能仕様

### 計算ルール

#### 返済負担率（住宅ローン年間返済額 ÷ 年収）

| 年収 | 返済負担率 |
|------|-----------|
| 400万円未満 | **30%** |
| 400万円以上 | **35%** |

**計算式**:
```
年間返済可能額 = 年収 × 返済負担率
月々返済可能額 = 年間返済可能額 ÷ 12

→ 逆算ロジックで借入可能額を算出
```

---

### 入力項目

#### 1. 本人の年収
- 単位: 万円
- 例: 500万円
- 増減ボタン: 10万円ずつ
- 範囲: 100万円〜3000万円

#### 2. 金利
- 単位: % (年利)
- デフォルト: 1.0%
- 増減ボタン: 0.01%ずつ
- 範囲: 0.1%〜5.0%
- **ユーザーが選択可能**（変動金利・固定金利など想定）

#### 3. 返済期間
- 単位: 年
- デフォルト: 35年
- 増減ボタン: 1年ずつ
- 範囲: 5年〜50年

#### 4. 連帯債務者・連帯保証人（オプション）

##### パターンA: 連帯債務者
- **定義**: 主債務者と同等の返済義務を持つ（夫婦で住宅ローンなど）
- **計算方法**: 年収を**100%**合算
- **例**:
  - 本人年収: 500万円
  - 連帯債務者年収: 400万円
  - → 合計年収: **900万円**（100%合算）

##### パターンB: 連帯保証人
- **定義**: 主債務者が返済不能時に代わりに返済（親が保証人など）
- **計算方法**: 年収を**50%**合算
- **例**:
  - 本人年収: 500万円
  - 連帯保証人年収: 600万円
  - → 合計年収: **800万円**（500 + 600×0.5）

##### UI仕様
```
[ ] 連帯債務者または連帯保証人がいる

  ↓ チェックを入れると以下が表示

  ⚪ 連帯債務者（年収を100%合算）
  ⚪ 連帯保証人（年収を50%合算）

  相手の年収: [____] 万円  [▲] [▼]
```

---

## 🎨 UI/UX設計

### 配置場所

**Tier 1（匿名ユーザー）**: 無料版機能として提供
- ログイン不要
- Homeページに新しいタブとして追加

**タブ構成**:
```
[ 借入額から計算 ] [ 返済額から計算 ] [ 年収から計算 ] ← NEW!
```

---

### 画面レイアウト

```
┌─────────────────────────────────────┐
│  年収から借入可能額を計算           │
├─────────────────────────────────────┤
│                                     │
│  💰 あなたの年収                    │
│  [  500  ] 万円  [▲] [▼]           │
│                                     │
│  📈 金利（年利）                    │
│  [ 1.00  ] %     [▲] [▼]           │
│                                     │
│  📅 返済期間                        │
│  [  35   ] 年    [▲] [▼]           │
│                                     │
│  ☑ 連帯債務者または連帯保証人がいる  │
│    ⚪ 連帯債務者（年収100%合算）     │
│    ⚪ 連帯保証人（年収50%合算）      │
│                                     │
│    相手の年収                       │
│    [ 400  ] 万円  [▲] [▼]          │
│                                     │
│  [ 計算する ]                       │
│                                     │
├─────────────────────────────────────┤
│  📊 計算結果                        │
│                                     │
│  ✅ あなたの借入可能額（最大）       │
│     5,890万円                       │
│                                     │
│  💡 返済負担率: 35%                 │
│     （年収500万円以上のため）        │
│                                     │
│  📌 月々の返済額                    │
│     約 140,835円                    │
│                                     │
│  ⚠️ 注意事項                        │
│  この金額は理論上の最大値です。      │
│  実際の借入額は、他の借入状況や      │
│  審査基準により異なります。          │
│                                     │
│  💰 無理のない返済計画を！           │
│  一般的には年収の5〜6倍程度が        │
│  安全な借入額の目安とされています。  │
│                                     │
│  [ 詳しい返済計画を立てる ]          │
│     ↓                               │
│  「借入額から計算」タブへ遷移        │
└─────────────────────────────────────┘
```

---

## 🧮 計算ロジック

### Step 1: 合算年収の計算

```typescript
let totalIncome = primaryIncome; // 本人年収

if (hasCoDebtor) {
  if (coDebtorType === 'joint-debtor') {
    // 連帯債務者: 100%合算
    totalIncome += coDebtorIncome;
  } else if (coDebtorType === 'guarantor') {
    // 連帯保証人: 50%合算
    totalIncome += coDebtorIncome * 0.5;
  }
}
```

### Step 2: 返済負担率の決定

```typescript
const repaymentRatio = totalIncome < 400 ? 0.30 : 0.35;
```

### Step 3: 年間返済可能額

```typescript
const annualRepayment = totalIncome * 10000 * repaymentRatio; // 万円→円変換
const monthlyRepayment = annualRepayment / 12;
```

### Step 4: 借入可能額（逆算）

**既存の逆算ロジックを流用**:
```typescript
// src/utils/loanCalculator.ts の calculateReverse を使用
const maxBorrowableAmount = calculateReverse({
  monthlyPayment: monthlyRepayment,
  interestRate: interestRate,
  years: years,
  months: 0,
  repaymentType: 'equal-payment', // 元利均等
  bonusPayment: { enabled: false } // ボーナスなし
});
```

---

## 📁 実装ファイル

### 新規作成

1. **`src/components/Input/IncomeForm.tsx`**
   - 年収入力フォーム
   - 金利・返済期間入力
   - 連帯債務者/保証人入力

2. **`src/types/income.ts`**
   - 型定義（IncomeParams, IncomeResult）

3. **`src/utils/incomeCalculator.ts`**
   - 年収ベース借入可能額計算ロジック
   - 既存の `calculateReverse` を内部で使用

4. **`tests/unit/incomeCalculator.test.ts`**
   - ユニットテスト

### 修正

1. **`src/pages/Home.tsx`**
   - タブに「年収から計算」を追加
   - IncomeForm コンポーネントを統合

2. **`src/contexts/LoanContext.tsx`**
   - 年収計算モードの状態管理（必要に応じて）

---

## ✅ テストケース

### Case 1: 基本計算（単独）
- **入力**: 年収500万円、金利1.0%、35年
- **期待値**:
  - 返済負担率: 35%
  - 年間返済可能額: 175万円
  - 月々返済額: 約145,833円
  - 借入可能額: 約5,100万円

### Case 2: 年収400万円未満
- **入力**: 年収350万円、金利1.0%、35年
- **期待値**:
  - 返済負担率: 30%
  - 年間返済可能額: 105万円
  - 月々返済額: 87,500円
  - 借入可能額: 約3,060万円

### Case 3: 連帯債務者（100%合算）
- **入力**: 本人500万円 + 連帯債務者400万円、金利1.0%、35年
- **期待値**:
  - 合算年収: 900万円
  - 返済負担率: 35%
  - 年間返済可能額: 315万円
  - 月々返済額: 262,500円
  - 借入可能額: 約9,180万円

### Case 4: 連帯保証人（50%合算）
- **入力**: 本人500万円 + 連帯保証人600万円、金利1.0%、35年
- **期待値**:
  - 合算年収: 800万円（500 + 600×0.5）
  - 返済負担率: 35%
  - 年間返済可能額: 280万円
  - 月々返済額: 233,333円
  - 借入可能額: 約8,160万円

---

## 🎯 アンカリング効果の活用戦略

### 1. 高い金額を先に見せる
「あなたは最大○○万円まで借りられます！」
→ ユーザーは高い金額を基準（アンカー）として認識

### 2. 現実的な返済額へ誘導
「詳しい返済計画を立てる」ボタン
→ 「借入額から計算」タブへ遷移
→ 実際の月々返済額を確認

### 3. 安心感を提供
注意事項で「年収の5〜6倍が安全な目安」と表示
→ ユーザーが自己判断で適正額を決める
→ 信頼感の向上

### 4. 次のアクションへ誘導
- 無料版: 「詳しい返済計画」でローン計算へ
- 有料版CTA: 「ライフプラン全体を見る」で登録促進

---

## 📊 マーケティング効果

### メリット
1. **早期エンゲージメント**: 最初に「借りられる額」を知りたいユーザーを捕捉
2. **心理的ハードルを下げる**: 「こんなに借りられる」→ 安心感
3. **SEO効果**: 「年収 住宅ローン 借入可能額」などのキーワードで流入増加
4. **差別化**: 他の住宅ローン計算機にない独自機能

### 注意点
- 過大な期待を持たせないよう注意事項を明記
- 金融機関の審査基準は別途存在することを説明
- 「理論上の最大値」であることを強調

---

## 🚀 実装優先度

**Priority**: 🟡 High（無料版の価値向上 + マーケティング効果）

**Phase**: Phase 9.8（無料版機能拡張）
- Phase 9.5: NISA複利計算 ✅ 完了
- Phase 9.8: 年収ベースMAX借入額計算 ← NEW!
- Phase 10-18: 有料版開発

**見積時間**: 約5時間
- 型定義・計算ロジック: 1時間
- UI実装（IncomeForm）: 2時間
- 統合・テスト: 1.5時間
- ドキュメント更新: 0.5時間

---

## 📝 関連ドキュメント

- `docs/DEVELOPMENT_PLAN.md`: 全体開発計画
- `docs/requirements.md`: 機能要件
- `src/utils/loanCalculator.ts`: 逆算ロジック（流用）
- `src/components/Input/ReverseLoanForm.tsx`: 逆算UI（参考）

---

**作成日**: 2025-10-27
**ステータス**: 🔵 仕様確定 → 実装準備中
